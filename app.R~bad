library(shiny)
library(shinyjs) 
library(bslib)
library(DT)
library(deldir)
library(jpeg)
library(dplyr)
library(renv)
library(readr)

##### UI #####

ui <- page_fillable(
  useShinyjs(),
  layout_columns(
    col_widths = c(4, 8),
    navset_card_pill(
      nav_panel("Instructions",
                h3("Developer Notes"),
                tags$div(
                         HTML("
                          <ul>
                          <li>This is v 0.1 with tabbed interface</li>
                          <li> I live at <a href='https://uruguay.bournemouth.ac.uk/shiny/users/mgreen/eyetracking_ae_shiny/' > https://uruguay.bournemouth.ac.uk/shiny/users/mgreen/eyetracking_ae_shiny/  </a> </li>
                          <li> My github is <a href='https://github.com/mjgreen/eyetracking_ae_shiny' > https://github.com/mjgreen/eyetracking_ae_shiny </a> </li>
                          <li> Use the Debug tab to inspect the internal state of the program but only when running from RStudio, not on the server</li>
                          </ul>
                          ")),
                hr(),
                h3("User Instructions"),
                tags$div(
                  HTML("
                    <ol> 
                    <li> Use the <strong>Fixation Report</strong> tab to upload your fixation report. Then dropdown boxes will appear and you should use those to say which columns correspond to which eye-tracking variables. You can download a suitable test fixation report <a href = 'https://mjgreen.github.io/eyetracking_ae_shiny/fixation_report.csv' > here </a> </li>
                    <li> Use the <strong>Faces upload</strong> tab to upload and annotate faces. Instructions for annotation are given in that tab. You can download two suitable faces as a zip file <a href = 'https://mjgreen.github.io/eyetracking_ae_shiny/sample_faces.zip' > here </a> </li>
                    <li> Check the <strong>Annotated fixation report</strong> tab to verify that the annotation is working: it will be empty until after you have finished the first face though. </li>
                    <li> Use the <strong>Save and exit</strong> tab to save the processed Fixation report </li>
                    </ol>
                    ")),
                hr()
      ),
      nav_panel("Fixation Report", 
                fileInput("upload_fixrep", "Upload fixation report", accept = c(".csv", ".xls", ".xlsx")),
                uiOutput("variable_selectors")
                
      ), 
      nav_panel("Faces Upload", 
                fileInput("upload_face", "Upload face", accept = "image/jpeg"),
                input_switch("toggle_fixations", "Toggle fixation visibility on/off"),
                p(paste0( "You can supply a name (like 'nose') for an AOI by writing it in the box below, ", "or let the app name the AOIs for you by not typing anything.")), p(paste0("Then use the mouse to single-click on the left-hand-side face to indicate the centroid ", "of an AOI (double-click removes the nearest centroid).")), p(paste0("When there are 2 or more AOIs, the right-hand-side face ", "will create and display AOI areas using Voronoi tesselation.")), textInput("aoi_name", "Type name for this AOI, then click in AOI", "a"), p( "You ", strong("MUST"), "click ", em('Annotate Current Face'), "before doing ", em('Start next face'), "or any ", em('Save and Exit'), "options. As soon as you have clicked 'Annotate Current Face', an annotated fixation report will be available in the tab ", strong("Annotated fixation report"), "on the right-hand-side next to", strong("Faces upload") ),
                actionButton("annotate", "Annotate current face"),
                actionButton("next_face", "Start next face")
      ), 
      nav_panel("Save and exit options",
                downloadButton("download_annotated", "Download annotated fixation report as .csv"),
                downloadButton("download_summary",   "Download summary report as .csv"),
                actionButton("write_all_rds", "Write annotated fixrep and summary locally as .rds (developer use only)"),
                actionButton("exit_app", "Exit App")
      ),
      nav_panel("To Do",
                h3("Developer notes"),
                p(paste0("Handle automatially running 'annotate this face' before either ", "(1) doing another face, or (2) saving the data and exiting.")),
                p(paste0("If we just call 'annotate this face' naively, then the current face ","would be duplicated across rows in the event that the user","did in fact use 'annotate this face' appropriately. ","However dplyr::distinct() might be good for this as it removes duplicate rows - ","Need to check whether rows are unique enough for this - I think if fiaxtion id is used, then using distinct should work.")),
                p(paste0("FIXED: double-click doesn't do anything")),
                p(paste0("selecting origin doesn't do anything"))
      ),
      nav_panel("Debug",
                h3("Developer buttons, not for use by Users"),
                actionButton("debug", "Debug (for developer use only)")
      )
    ),
    navset_card_pill(
      nav_panel("Faces edit", card(fluidRow(column(6, plotOutput("face_for_edit", click = "face_for_edit_click", dblclick = "face_for_edit_dblclick")),column(6, plotOutput("face_for_markup"))))),
      nav_panel("Annotated fixation report", dataTableOutput('table'))
    )
    )
  )



##### SREVER #####

server <- function(input, output, session) {
  face_width <- 600
  face_height <- 800
  face_plot_scale <- 0.9

  safe_timestamp <- function() {
    format(Sys.time(), "%Y-%m-%d_%H-%M-%S")
  }

  read_fixation_report <- function(upload_path) {
    extension <- tools::file_ext(upload_path)

    if (extension == "xls") {
      message("xls option")
      return(read_delim(
        upload_path,
        locale = readr::locale(encoding = "UTF-16LE"),
        show_col_types = FALSE
      ))
    }

    if (extension == "csv") {
      message("csv option")
      return(read_csv(upload_path, show_col_types = FALSE))
    }

    if (extension == "xlsx") {
      message("xlsx option")
      return(readxl::read_xlsx(upload_path))
    }

    stop("Unsupported fixation report extension: ", extension)
  }

  build_variable_selectors <- function(fixrep_raw) {
    fixrep_columns <- names(fixrep_raw)
    tagList(
      radioButtons(
        inputId = "origin_location",
        label = "Fixation Report (0,0) is at:",
        choices = c("top-left of screen", "centre of screen", "bottom-left of screen"),
        selected = character(0)
      ),
      selectInput("participant_id", "Select Participant ID Variable", choices = fixrep_columns),
      selectInput("trial_id", "Select Trial ID Variable", choices = fixrep_columns),
      selectInput("fix_id", "Select Fixation Index Variable", choices = fixrep_columns),
      selectInput("x_var", "Select Eye X Coordinate Variable", choices = fixrep_columns),
      selectInput("y_var", "Select Eye Y Coordinate Variable", choices = fixrep_columns),
      selectInput("face_filename", "Select Face File Name Variable", choices = fixrep_columns),
      selectInput("fixation_duration", "Select Fixation Duration Variable", choices = fixrep_columns),
      selectInput("condition1", "Condition Variable 1", choices = c("None", fixrep_columns)),
      selectInput("condition2", "Condition Variable 2", choices = c("None", fixrep_columns))
    )
  }

  build_fixrep <- function(fixrep_raw) {
    nrows_of_fixrep <- nrow(fixrep_raw)

    if (input$condition1 == "None") {
      condition1_var <- rep(as.character(NA), times = nrows_of_fixrep)
    } else {
      condition1_var <- fixrep_raw %>% pull(input$condition1)
    }

    tibble(
      subject_id = fixrep_raw %>% pull(input$participant_id),
      trial_id = fixrep_raw %>% pull(input$trial_id),
      condition1 = condition1_var,
      face_jpeg = fixrep_raw %>% pull(input$face_filename),
      fix_x = fixrep_raw %>% pull(input$x_var),
      fix_y = fixrep_raw %>% pull(input$y_var),
      fix_dur = fixrep_raw %>% pull(input$fixation_duration)
    )
  }

  make_aoi_name <- function(current_name) {
    if (current_name == "a") {
      return(paste0(current_name, sample(LETTERS, 1), sample(0:9, 1)))
    }
    current_name
  }

  remove_nearest_aoi <- function(aois, click_x, click_y) {
    if (nrow(aois) == 0) {
      return(aois)
    }

    aois %>%
      mutate(dist = sqrt((x - click_x)^2 + (y - click_y)^2)) %>%
      slice(-which.min(dist)) %>%
      select(-dist)
  }

  annotate_fixations <- function(fixrep_this_face, vor, aois) {
    if (nrow(fixrep_this_face) == 0 || nrow(aois) < 2 || is.null(vor)) {
      return(fixrep_this_face)
    }

    tile_lookup <- tile.list(vor)
    tile_numbers <- vapply(
      seq_len(nrow(fixrep_this_face)),
      function(i) {
        which.tile(fixrep_this_face$fix_x[i], fixrep_this_face$fix_y[i], tile_lookup)
      },
      numeric(1)
    )

    fixrep_this_face %>%
      mutate(
        tile = tile_numbers,
        tile_name = aois$aoi_name[tile_numbers]
      )
  }

  build_summary <- function(fixrep_with_annotation) {
    fixrep_with_annotation %>%
      group_by(subject_id, trial_id, condition1, face_jpeg, tile_name) %>%
      summarise(
        dwell_time = sum(fix_dur),
        n_fixations = n(),
        avge_dwell_time_per_fixation = dwell_time / n_fixations,
        .groups = "drop"
      ) %>%
      group_by(condition1, tile_name) %>%
      summarise(
        mean_dwell_time = mean(dwell_time),
        mean_n_fixations = mean(n_fixations),
        mean_avge_dwell_time_per_fixation = mean(avge_dwell_time_per_fixation),
        .groups = "drop"
      )
  }

  face_jpeg <- reactive({
    jpegfile <- input[["upload_face"]]
    if (!is.null(jpegfile)) {
      readJPEG(jpegfile$datapath, native = TRUE)
    }
  })

  do_deldir <- reactive({
    if (nrow(g$aois) >= 2) {
      deldir(
        x = g$aois$x,
        y = g$aois$y,
        id = g$aois$aoi_name,
        rw = c(xleft = 0, xright = face_width, ybottom = 0, ytop = face_height)
      )
    }
  })
  
  # Globally accessible variables
  g = reactiveValues(
    aois_all = tibble(),
    aois = tibble(),
    fixrep_raw = NA,
    fixrep = NA,
    fixrep_this_face = NA,
    fixrep_with_annotation = tibble(),
    summary_file = tibble(),
    vor = NA
  )
  
  observe({
    reactiveValuesToList(g)
  })
  
<<<<<<< HEAD
=======
  ### FUNCTIONS ###

  # Read face jpeg function
  myjpeg = reactive({
    jpegfile <- input[['upload_face']]
    if(!is.null(jpegfile)){
      readJPEG(jpegfile$datapath, native=TRUE) 
    }
  })
  
  # Calculate tesselation function
  do_deldir = reactive({
    if(nrow(g$aois) >= 2){
      deldir(
        x = g$aois$x, 
        y = g$aois$y, 
        id = g$aois$aoi_name,
        rw = c(xleft = 0, xright=600, ybottom=0, ytop=800)
      )
    }
  })
  
  ### END FUNCTIONS ###
  
>>>>>>> parent of fef9abe (Fixed annoyances)
  # Respond to upload fixation report button
  observeEvent(input$upload_fixrep, {
    g$fixrep_raw <- read_fixation_report(input$upload_fixrep$datapath)

    output$variable_selectors <- renderUI({
      if (!is.null(g$fixrep_raw)) {
        build_variable_selectors(g$fixrep_raw)
      }
    })
  })


  # Make fixrep this face after fixrep and face are uploaded
  observe({
<<<<<<< HEAD
    req(!is.null(input$upload_face), !is.null(input$upload_fixrep), !is.null(g$fixrep_raw))

    g$fixrep <- build_fixrep(g$fixrep_raw)
    g$fixrep_this_face <- g$fixrep %>% filter(face_jpeg == input$upload_face$name)
  })
=======
    if(!is.null(input$upload_face) && !is.null(input$upload_fixrep)){
      nrows_of_fixrep = nrow(g$fixrep_raw)
      if(input$condition1 == "None"){condition1_var = rep(as.character(NA), times=nrows_of_fixrep)}
      if(input$condition1 != "None"){condition1_var = g$fixrep_raw %>% pull(input$condition1)}
      g$fixrep=tibble(
        subject_id = g$fixrep_raw %>% pull(input$participant_id),
        trial_id = g$fixrep_raw %>% pull(input$trial_id),
        condition1 = condition1_var,
        #condition2 = ifelse(input$condition2 =="None", NA, g$fixrep_raw %>% pull(input$condition2)),
        face_jpeg = g$fixrep_raw %>% pull(input$face_filename),
        fix_x = g$fixrep_raw %>% pull(input$x_var) - ((1920-600)/2),
        fix_y = g$fixrep_raw %>% pull(input$y_var) - ((1080-600)/2),
        fix_dur = g$fixrep_raw %>% pull(input$fixation_duration),
      )
      g$fixrep_this_face = g$fixrep %>% filter(face_jpeg == input$upload_face$name)
    }})
>>>>>>> parent of fef9abe (Fixed annoyances)


  # Respond to clicks on the face
  observeEvent(input[['face_for_edit_click']], {
    # Make AOI name
    aoi_name <- make_aoi_name(input$aoi_name)
    updateTextInput(session, "aoi_name", value = "a")

    this_aoi <- tibble(
      x = input$face_for_edit_click$x,
      y = input$face_for_edit_click$y,
      jpg = input[["upload_face"]]$name,
      aoi_name = aoi_name
    )
    g$aois <- g$aois %>% bind_rows(this_aoi)
  })
  
  # Respond to double-click in face - Remove aoi on double click
  observeEvent(input$face_for_edit_dblclick, {
    click_x <- input$face_for_edit_dblclick$x
    click_y <- input$face_for_edit_dblclick$y
    g$aois <- remove_nearest_aoi(g$aois, click_x, click_y)

    if (nrow(g$aois) >= 2) {
      g$vor <- do_deldir()
    }
  })
  
  
  # Respond to annotate
  observeEvent(input[['annotate']], {
    g$fixrep_this_face <- annotate_fixations(g$fixrep_this_face, g$vor, g$aois)
    g$fixrep_with_annotation <- g$fixrep_with_annotation %>% bind_rows(g$fixrep_this_face)
    g$aois_all <- g$aois_all %>% bind_rows(g$aois)
    g$summary_file <- build_summary(g$fixrep_with_annotation)
  })
  
  # Respond to start next face
  observeEvent(input[['next_face']], {
    g$aois_all <- g$aois_all %>% bind_rows(g$aois)
    g$aois <- tibble()
    reset("toggle_fixations")
    reset("upload_face")
    shinyjs::runjs("document.getElementById('upload_face').click();")
  })
  
  # Respond to debug
  observeEvent(input[['debug']], {
    browser()
  })
  
  # Respond to write rds
  observeEvent(input[['write_all_rds']], {
    mytimestamp = Sys.time() %>% gsub(pattern=" ", replacement="_") %>% gsub(pattern=".", replacement="_", fixed=TRUE)
    saveRDS(g$fixrep_with_annotation, file.path("outputs", paste0(mytimestamp, "-fixrep_with_annotation",  ".rds")))
    saveRDS(g$summary_file,           file.path("outputs", paste0(mytimestamp, "-summary-file",            ".rds")))
  })

  # Respond to download_annotated
  output$download_annotated <- downloadHandler(
    filename = function() {
      paste("data-", Sys.time() %>% gsub(pattern=" ", replacement="_") %>% gsub(pattern=".", replacement="_", fixed=TRUE), "-fixrep_with_annotation", ".csv", sep="")
    },
    content = function(file) {
      write.csv(g$fixrep_with_annotation, file)
    }
  )
  
  # Respond to download_summary
  output$download_summary <- downloadHandler(
    filename = function() {
      paste("data-", Sys.time() %>% gsub(pattern=" ", replacement="_") %>% gsub(pattern=".", replacement="_", fixed=TRUE), "-summary", ".csv", sep="")
    },
    content = function(file) {
      write.csv(g$summary_file, file)
    }
  )

  # Observe exit_app
  observeEvent(input$exit_app, {
    stopApp()
  })
  
  # OUTPUT
  
  # Prepare the plot for the left-hand-side
  output[['face_for_edit']] <- renderPlot({
    if(!is.null(face_jpeg())){
      plot(x=0, y=0, type='n', xlim = c(0, face_width), ylim = c(face_height, 0), xaxt='n', xlab=NA, ylab=NA, axes=F, asp=1)
      title("Click to define AOIs", line=2)
      axis(2, at=c(0,face_height), las=1)
      axis(3, at=c(0,face_width))
      mtext("Assuming eye-tracker has (0,0) at top-left", side=3, line=1)
      rasterImage(face_jpeg(), xleft=0, ybottom=face_height, xright=face_width, ytop=0) 
      if(nrow(g$aois) > 0){
        points(x=g$aois$x, y=g$aois$y, pch=21, col="red", bg="red", cex=5)
      }}}, 
    width=face_width * face_plot_scale, height=face_height * face_plot_scale)
  
  # Prepare the plot for the RIGHT-hand-side
  output[['face_for_markup']] <- renderPlot({
    if(!is.null(face_jpeg())){
      plot(x=0, y=0, type='n', xlim = c(0, face_width), ylim = c(face_height, 0), xaxt='n', xlab=NA, ylab=NA, axes=F, asp=1)
      axis(2, at=c(0,face_height), las=1)
      axis(3, at=c(0,face_width))
      mtext("Assuming eye-tracker has (0,0) at top-left", side=3, line=1)
      rasterImage(face_jpeg(), xleft=0, ybottom=face_height, xright=face_width, ytop=0) 
      if(input$toggle_fixations==TRUE){
        points(g$fixrep_this_face$fix_x, g$fixrep_this_face$fix_y, pch=21, bg="yellow", cex=5)
        text(g$fixrep_this_face$fix_x, g$fixrep_this_face$fix_y)
        text(g$fixrep_this_face$fix_x, g$fixrep_this_face$fix_y, 
             labels=paste0("(",g$fixrep_this_face$fix_x, ", ", g$fixrep_this_face$fix_y, ")"),
             pos=1, offset=2, col="yellow", cex=2)
      }
      if(nrow(g$aois) >= 2){
        vor <- do_deldir()
        g$vor = vor
        plot(vor, add=TRUE, wlines="tess", showpoints=FALSE, showrect=TRUE, labelPts=TRUE, lwd=3, cex=2, lex=3, cmpnt_col=c(tri=1,tess=1,points=1,labels=2,rect=1), cmpnt_lty=c(tri=1,tess=2), axes=TRUE)
      }}}, 
    width=face_width * face_plot_scale, height=face_height * face_plot_scale)
  
  # Table
  output$table <- DT::renderDT(g$fixrep_with_annotation)
  
}

shinyApp(ui = ui, server = server)
